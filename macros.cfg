[respond]

[gcode_macro POWER_OFF_PRINTER]
gcode:
    {% if printer.idle_timeout.state == "Printing"%}
    M117 Stop print first
    RESPOND TYPE=error MSG="Cancel print before poweroff printer"
    {% else %}
    {action_emergency_stop("\"POWER_OFF_PRINTER\"")}
    {% endif %}

[gcode_macro SYSTEM_SHUTDOWN]
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
    M117 Stop print first
    RESPOND TYPE=error MSG="Cancel print before system shutdown"
    {% else %}
    POWER_OFF_PRINTER
    {action_call_remote_method("shutdown_machine")}
    {% endif %}

[gcode_macro SYSTEM_RESTART]
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
    M117 Stop print first
    RESPOND TYPE=error MSG="Cancel print before system restart"
    {% else %}
    POWER_OFF_PRINTER
    {action_call_remote_method("reboot_machine")}
    {% endif %}
